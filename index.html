<!doctype html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maestro Inventarios | El Cedro</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- SheetJS (XLSX) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script defer src="app.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">EC</div>
      <div>
        <div class="title">Maestro Inventarios</div>
        <div class="subtitle">Carga tu archivo (XLSX/CSV) y analiza por sucursal</div>
      </div>
    </div>

    <div class="actions">
      <label class="upload">
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <span>üì§ Cargar archivo</span>
      </label>
      <button id="btnClear" class="btn secondary" disabled>Limpiar</button>
    </div>
  </header>

  <main class="container">
    <section id="status" class="card status">
      <div class="status-left">
        <div class="status-title">Estado</div>
        <div id="statusMsg" class="status-msg">Carga un archivo para comenzar.</div>
        <div id="statusMeta" class="status-meta"></div>
      </div>
      <div class="status-right">
        <div class="pill" id="pillPrivacy">‚úÖ Procesamiento local (no se sube a internet)</div>
      </div>
    </section>

    <section class="card tabs">
      <!-- EXISTENTES -->
      <button id="tabSummary" class="tab active" disabled>Resumen General</button>
      <button id="tabDetail" class="tab" disabled>Detalle por Sucursal</button>

      <!-- NUEVAS -->
      <button id="tabFinder" class="tab" disabled>Buscador SKU</button>
      <button id="tabOppBreak" class="tab" disabled>Oportunidades (Quiebres)</button>
      <button id="tabOppOver" class="tab" disabled>Oportunidades (Sobreinv)</button>
      <button id="tabHistCateg" class="tab" disabled>Hist√≥rico Categor√≠as</button>
      <button id="tabHistMarca" class="tab" disabled>Hist√≥rico Marcas</button>

      <div class="tab-note">Clic para cambiar de vista</div>
    </section>

    <!-- ================== RESUMEN GENERAL ================== -->
    <section id="summaryView" class="view">
      <section class="card kpis">
        <div class="card-header">
          <h2>Foto General</h2>

          <div class="header-right">
            <div class="inline-field">
              <label class="inline-label">Sucursal (Executive)</label>
              <select id="summaryWarehouseSelect" disabled>
                <option value="ALL">Todas</option>
              </select>
            </div>
          </div>

          <div class="hint">Umbrales: Riesgo &lt; 15 d√≠as ‚Ä¢ Sobreinventario &gt; 60 d√≠as</div>
        </div>

        <div class="kpi-grid kpi-grid-4">
          <div class="kpi">
            <div class="kpi-label">Meses usados</div>
            <div class="kpi-value" id="gMeses">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">SKUs √∫nicos</div>
            <div class="kpi-value" id="gSkus">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Inventario total (piezas)</div>
            <div class="kpi-value" id="gInv">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Cobertura global (d√≠as)</div>
            <div class="kpi-value" id="gCobDias">‚Äî</div>
          </div>
        </div>

        <div class="kpi-grid kpi-grid-4 mt12">
          <div class="kpi">
            <div class="kpi-label">Prom. venta mensual total</div>
            <div class="kpi-value" id="gPromMes">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">% SKUs Riesgo (&lt;15 d√≠as)</div>
            <div class="kpi-value" id="gRiskPct">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">% SKUs Sobreinv (&gt;60 d√≠as)</div>
            <div class="kpi-value" id="gOverPct">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="kpi-label">Sin Mov con inventario</div>
            <div class="kpi-value" id="gSinMovInv">‚Äî</div>
          </div>
        </div>
      </section>

      <section class="grid2">
        <section class="card chart-card">
          <div class="card-header">
            <h2>Clasificaci√≥n por sucursal (100% apilado)</h2>
            <div class="hint">A / B / C / Sin Mov por porcentaje</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartStacked"></canvas>
          </div>
        </section>

        <section class="card chart-card">
          <div class="card-header">
            <h2>Riesgo & Sobreinventario por sucursal</h2>
            <div class="hint">&lt;15 d√≠as y &gt;60 d√≠as</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartRiskOver"></canvas>
          </div>
        </section>
      </section>

      <section class="card table-card">
        <div class="card-header">
          <h2>Matriz ejecutiva por sucursal</h2>
          <div class="hint">Conteo y % por clasificaci√≥n + inventario y cobertura (mediana)</div>
        </div>
        <div class="table-wrap">
          <table id="heatTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="grid2">
        <section class="card">
          <div class="card-header">
            <h2>Rankings</h2>
            <div class="hint">Basados en % SKUs (conteo) y piezas (inventario)</div>
          </div>

          <div class="rank-grid">
            <div class="rank">
              <div class="rank-title">Top Riesgo (&lt;15 d√≠as)</div>
              <ol id="rankRisk" class="rank-list"></ol>
            </div>
            <div class="rank">
              <div class="rank-title">Top Sobreinventario (&gt;60 d√≠as)</div>
              <ol id="rankOver" class="rank-list"></ol>
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Hallazgos autom√°ticos</h2>
            <div class="hint">Texto listo para direcci√≥n</div>
          </div>
          <ul id="insights" class="insights"></ul>
        </section>
      </section>
    </section>

    <!-- ================== DETALLE POR SUCURSAL ================== -->
    <section id="detailView" class="view hidden">
      <section class="grid">
        <section class="card filters">
          <div class="card-header">
            <h2>Filtros</h2>
            <div class="hint">Clic en encabezados para ordenar</div>
          </div>

          <div class="form">
            <div class="field">
              <label>Sucursal</label>
              <select id="warehouseSelect" disabled></select>
            </div>

            <div class="field">
              <label>Clasificaci√≥n</label>
              <select id="classSelect" disabled>
                <option value="ALL">Todas</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="Sin Mov">Sin Mov</option>
              </select>
            </div>

            <div class="field">
              <label>B√∫squeda (C√≥digo o Descripci√≥n)</label>
              <input id="searchInput" type="text" placeholder="Ej. BER 001... o BARNIZ..." disabled />
            </div>

            <div class="field">
              <label>Solo inventario &gt; 0</label>
              <label class="switch">
                <input id="onlyInvToggle" type="checkbox" disabled />
                <span class="slider"></span>
              </label>
            </div>

            <div class="field">
              <label>Rango Cobertura (D√≠as)</label>
              <div class="range">
                <input id="covMin" type="number" placeholder="M√≠n" disabled />
                <input id="covMax" type="number" placeholder="M√°x" disabled />
              </div>
              <div class="hint2">Deja vac√≠o para no filtrar</div>
            </div>

            <div class="field">
              <label>Atajos</label>
              <div class="chips">
                <label class="chip">
                  <input id="onlySinMovInv" type="checkbox" disabled />
                  <span>Sin Mov con inventario</span>
                </label>
                <label class="chip">
                  <input id="onlyABZero" type="checkbox" disabled />
                  <span>A/B con inventario 0</span>
                </label>
              </div>
            </div>

            <button id="btnExport" class="btn" disabled>‚¨áÔ∏è Exportar vista (CSV)</button>
          </div>
        </section>

        <section class="card kpis">
          <div class="card-header">
            <h2>KPIs sucursal</h2>
            <div class="hint">Recalculados con filtros</div>
          </div>

          <div class="kpi-grid kpi-grid-4">
            <div class="kpi">
              <div class="kpi-label">Meses usados</div>
              <div class="kpi-value" id="kpiMeses">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">SKUs (vista)</div>
              <div class="kpi-value" id="kpiSkus">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Inv total (piezas)</div>
              <div class="kpi-value" id="kpiInv">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Cobertura (d√≠as) mediana</div>
              <div class="kpi-value" id="kpiCobMed">‚Äî</div>
            </div>
          </div>

          <div class="kpi-grid kpi-grid-4 mt12">
            <div class="kpi">
              <div class="kpi-label">Prom. venta mes (total)</div>
              <div class="kpi-value" id="kpiProm">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">% Riesgo (&lt;15 d√≠as)</div>
              <div class="kpi-value" id="kpiRisk">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">% Sobreinv (&gt;60 d√≠as)</div>
              <div class="kpi-value" id="kpiOver">‚Äî</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Sin Mov con inv</div>
              <div class="kpi-value" id="kpiSinMovInv">‚Äî</div>
            </div>
          </div>

          <div class="kpi-breakdown">
            <div class="mini"><span class="dot a"></span> A: <b id="kpiA">‚Äî</b></div>
            <div class="mini"><span class="dot b"></span> B: <b id="kpiB">‚Äî</b></div>
            <div class="mini"><span class="dot c"></span> C: <b id="kpiC">‚Äî</b></div>
            <div class="mini"><span class="dot s"></span> Sin Mov: <b id="kpiS">‚Äî</b></div>
          </div>
        </section>
      </section>

      <section class="grid2">
        <section class="card chart-card">
          <div class="card-header">
            <h2>Distribuci√≥n Cobertura (d√≠as)</h2>
            <div class="hint">0‚Äì15, 16‚Äì30, 31‚Äì60, 61‚Äì120, &gt;120</div>
          </div>
          <div class="chart-wrap">
            <canvas id="chartHist"></canvas>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <h2>Top SKUs</h2>
            <div class="hint">Sobreinventario vs Riesgo</div>
          </div>

          <div class="rank-grid">
            <div class="rank">
              <div class="rank-title">Top 15 Sobreinventario</div>
              <ol id="topOver" class="rank-list small"></ol>
            </div>
            <div class="rank">
              <div class="rank-title">Top 15 Riesgo</div>
              <ol id="topRisk" class="rank-list small"></ol>
            </div>
          </div>
        </section>
      </section>

      <section class="card table-card">
        <div class="card-header">
          <h2>Tabla</h2>
          <div class="hint" id="tableHint">‚Äî</div>
        </div>

        <div class="table-wrap">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="pager">
            <button id="detailPrev" class="btn tiny secondary" disabled>‚óÄ</button>
            <span id="detailPageInfo" class="muted">‚Äî</span>
            <button id="detailNext" class="btn tiny secondary" disabled>‚ñ∂</button>
          </div>
          <div class="pager">
            <label class="muted">Filas:</label>
            <select id="detailPageSize" class="miniSelect" disabled>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </section>
    </section>

    <!-- ================== BUSCADOR SKU (multi-sucursal) ================== -->
    <section id="finderView" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2>Buscador SKU (todas las sucursales)</h2>
          <div class="hint">Busca por C√≥digo o Descripci√≥n. Ver√°s clasificaci√≥n + inventario por sucursal.</div>
        </div>

        <div class="toolbar">
          <input id="finderSearch" class="input" type="text" placeholder="Buscar‚Ä¶ (c√≥digo o descripci√≥n)" disabled />
          <label class="chip">
            <input id="finderOnlyInv" type="checkbox" disabled />
            <span>Solo SKUs con inv &gt; 0 en alguna sucursal</span>
          </label>
          <button id="finderExport" class="btn" disabled>‚¨áÔ∏è Exportar (CSV)</button>
        </div>

        <div class="table-wrap">
          <table id="finderTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="pager">
            <button id="finderPrev" class="btn tiny secondary" disabled>‚óÄ</button>
            <span id="finderPageInfo" class="muted">‚Äî</span>
            <button id="finderNext" class="btn tiny secondary" disabled>‚ñ∂</button>
          </div>
          <div class="pager">
            <label class="muted">Filas:</label>
            <select id="finderPageSize" class="miniSelect" disabled>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </section>
    </section>

    <!-- ================== OPORTUNIDADES: EVITAR QUIEBRES ================== -->
    <section id="oppBreakView" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2>Oportunidades: evitar quiebres</h2>
          <div class="hint">Sucursal objetivo: toma A/B con riesgo (&lt;15 d√≠as) y busca ese SKU en otras sucursales en C/Sin Mov con inventario.</div>
        </div>

        <div class="toolbar">
          <div class="inline-field">
            <label class="inline-label">Sucursal objetivo</label>
            <select id="oppBreakTarget" disabled></select>
          </div>

          <label class="chip">
            <input id="oppBreakOnlyRisk" type="checkbox" checked disabled />
            <span>Solo riesgo (&lt;15 d√≠as)</span>
          </label>

          <button id="oppBreakExport" class="btn" disabled>‚¨áÔ∏è Exportar (CSV)</button>
        </div>

        <div class="table-wrap">
          <table id="oppBreakTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="pager">
            <button id="oppBreakPrev" class="btn tiny secondary" disabled>‚óÄ</button>
            <span id="oppBreakPageInfo" class="muted">‚Äî</span>
            <button id="oppBreakNext" class="btn tiny secondary" disabled>‚ñ∂</button>
          </div>
          <div class="pager">
            <label class="muted">Filas:</label>
            <select id="oppBreakPageSize" class="miniSelect" disabled>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </section>
    </section>

    <!-- ================== OPORTUNIDADES: REDUCIR SOBREINVENTARIO ================== -->
    <section id="oppOverView" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2>Oportunidades: reducir sobreinventario</h2>
          <div class="hint">Sucursal objetivo: toma C/Sin Mov con sobreinv (&gt;60 d√≠as) y busca sucursales donde ese SKU est√° en A/B.</div>
        </div>

        <div class="toolbar">
          <div class="inline-field">
            <label class="inline-label">Sucursal objetivo</label>
            <select id="oppOverTarget" disabled></select>
          </div>

          <label class="chip">
            <input id="oppOverOnlyOver" type="checkbox" checked disabled />
            <span>Solo sobreinv (&gt;60 d√≠as)</span>
          </label>

          <button id="oppOverExport" class="btn" disabled>‚¨áÔ∏è Exportar (CSV)</button>
        </div>

        <div class="table-wrap">
          <table id="oppOverTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="table-footer">
          <div class="pager">
            <button id="oppOverPrev" class="btn tiny secondary" disabled>‚óÄ</button>
            <span id="oppOverPageInfo" class="muted">‚Äî</span>
            <button id="oppOverNext" class="btn tiny secondary" disabled>‚ñ∂</button>
          </div>
          <div class="pager">
            <label class="muted">Filas:</label>
            <select id="oppOverPageSize" class="miniSelect" disabled>
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </section>
    </section>

    <!-- ================== HISTORICO CATEGORIAS ================== -->
    <section id="histCategView" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2>Hist√≥rico por Categor√≠a</h2>
          <div class="hint">Fuente: hoja <b>RESUMEN_MES_SUC_CATEG</b>. Depende de filtros. Incluye 2 tablas (detalle + hist√≥rico por sucursal) y litros por sucursal.</div>
        </div>

        <div class="toolbar">
          <div class="inline-field">
            <label class="inline-label">Sucursal</label>
            <select id="histCategSucursal" disabled>
              <option value="ALL">Todas</option>
            </select>
          </div>

          <div class="inline-field">
            <label class="inline-label">Buscar categor√≠a</label>
            <input id="histCategSearch" class="input" type="text" placeholder="Ej. PINTURA..." disabled />
          </div>

          <div class="inline-field">
            <label class="inline-label">Mes desde</label>
            <input id="histCategFrom" class="input" type="text" placeholder="YYYY-MM" disabled />
          </div>
          <div class="inline-field">
            <label class="inline-label">Mes hasta</label>
            <input id="histCategTo" class="input" type="text" placeholder="YYYY-MM" disabled />
          </div>

          <button id="histCategExport" class="btn" disabled>‚¨áÔ∏è Exportar (CSV)</button>
        </div>

        <section class="grid2">
          <section class="card inner">
            <div class="card-header">
              <h2>Hist√≥rico $ por mes x sucursal</h2>
              <div class="hint">Totales mensuales (todas las categor√≠as aplicando filtros)</div>
            </div>
            <div class="table-wrap">
              <table id="histCategPivotMoney">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <section class="card inner">
            <div class="card-header">
              <h2>Hist√≥rico Litros por mes x sucursal</h2>
              <div class="hint">Litros Vendidos mensuales (aplicando filtros)</div>
            </div>
            <div class="table-wrap">
              <table id="histCategPivotLitros">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </section>
        </section>

        <section class="card inner mt12">
          <div class="card-header">
            <h2>Detalle (Categor√≠a)</h2>
            <div class="hint">Mes, Sucursal, Categor√≠a, Monto_venta ($), Litros Vendidos</div>
          </div>
          <div class="table-wrap">
            <table id="histCategDetail">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="table-footer">
            <div class="pager">
              <button id="histCategPrev" class="btn tiny secondary" disabled>‚óÄ</button>
              <span id="histCategPageInfo" class="muted">‚Äî</span>
              <button id="histCategNext" class="btn tiny secondary" disabled>‚ñ∂</button>
            </div>
            <div class="pager">
              <label class="muted">Filas:</label>
              <select id="histCategPageSize" class="miniSelect" disabled>
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
              </select>
            </div>
          </div>
        </section>
      </section>
    </section>

    <!-- ================== HISTORICO MARCAS ================== -->
    <section id="histMarcaView" class="view hidden">
      <section class="card">
        <div class="card-header">
          <h2>Hist√≥rico por Marca</h2>
          <div class="hint">Fuente: hoja <b>RESUMEN_MES_SUC_MARCA</b>. Depende de filtros. Incluye 2 tablas (detalle + hist√≥rico por sucursal) y litros por sucursal.</div>
        </div>

        <div class="toolbar">
          <div class="inline-field">
            <label class="inline-label">Sucursal</label>
            <select id="histMarcaSucursal" disabled>
              <option value="ALL">Todas</option>
            </select>
          </div>

          <div class="inline-field">
            <label class="inline-label">Buscar marca</label>
            <input id="histMarcaSearch" class="input" type="text" placeholder="Ej. TRUPER..." disabled />
          </div>

          <div class="inline-field">
            <label class="inline-label">Mes desde</label>
            <input id="histMarcaFrom" class="input" type="text" placeholder="YYYY-MM" disabled />
          </div>
          <div class="inline-field">
            <label class="inline-label">Mes hasta</label>
            <input id="histMarcaTo" class="input" type="text" placeholder="YYYY-MM" disabled />
          </div>

          <button id="histMarcaExport" class="btn" disabled>‚¨áÔ∏è Exportar (CSV)</button>
        </div>

        <section class="grid2">
          <section class="card inner">
            <div class="card-header">
              <h2>Hist√≥rico $ por mes x sucursal</h2>
              <div class="hint">Totales mensuales (todas las marcas aplicando filtros)</div>
            </div>
            <div class="table-wrap">
              <table id="histMarcaPivotMoney">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <section class="card inner">
            <div class="card-header">
              <h2>Hist√≥rico Litros por mes x sucursal</h2>
              <div class="hint">Litros Vendidos mensuales (aplicando filtros)</div>
            </div>
            <div class="table-wrap">
              <table id="histMarcaPivotLitros">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
          </section>
        </section>

        <section class="card inner mt12">
          <div class="card-header">
            <h2>Detalle (Marca)</h2>
            <div class="hint">Mes, Sucursal, Marca, Monto_venta ($), Litros Vendidos</div>
          </div>
          <div class="table-wrap">
            <table id="histMarcaDetail">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="table-footer">
            <div class="pager">
              <button id="histMarcaPrev" class="btn tiny secondary" disabled>‚óÄ</button>
              <span id="histMarcaPageInfo" class="muted">‚Äî</span>
              <button id="histMarcaNext" class="btn tiny secondary" disabled>‚ñ∂</button>
            </div>
            <div class="pager">
              <label class="muted">Filas:</label>
              <select id="histMarcaPageSize" class="miniSelect" disabled>
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="500">500</option>
              </select>
            </div>
          </div>
        </section>
      </section>
    </section>

  </main>

  <footer class="footer">
    <div>¬© El Cedro ‚Ä¢ Web local para an√°lisis interno ‚Ä¢ No sube archivos</div>
  </footer>
</body>
</html>
